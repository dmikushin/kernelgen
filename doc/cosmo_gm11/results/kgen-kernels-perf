#!/usr/bin/perl -w

if (scalar(@ARGV) != 1)
{
	print "Kernelgen kernels performance summary\n";
	print "Usage: kgen-kernels-perf <kernelgen.stats>\n";
	exit 0;
}

my($filename) = $ARGV[0];

my(%kernels) = ();

my(@lines) = split("\n", `cat kernelgen.stats`);
foreach $line (@lines)
{
	if ($line =~ m/^(\+|\-)\t(?<NAME>\w+)\t(?<CPU>[^\t]+)\t(?<GPU>[^\t]+)/)
	{
		my($kernel) = $+{NAME};
		my($cpu_time) = $+{CPU};
		my($gpu_time) = $+{GPU};
		if (!exists($kernels{$kernel}))
		{
			$kernels{$kernel} = [ 1, $cpu_time, $gpu_time ];
		}
		else
		{
			$kernels{$kernel}[0]++;
			$kernels{$kernel}[1] += $cpu_time;
			$kernels{$kernel}[2] += $gpu_time;
		}
	}
}

foreach $kernel (keys %kernels)
{
	my($nrecords) = $kernels{$kernel}[0];
	my($avg_cpu_time) = $kernels{$kernel}[1] / $nrecords;
	my($avg_gpu_time) = $kernels{$kernel}[2] / $nrecords;
	printf("%s\t%e\t%e\n", $kernel, $avg_cpu_time, $avg_gpu_time);
}

