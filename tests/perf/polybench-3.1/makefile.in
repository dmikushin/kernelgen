COMP = kernelgen-gcc -include malloc.h

BASE = ../..

TARGETS = 2mm 3mm atax bicg

.PHONY: $(TARGETS)

all: $(TARGETS)

polybench.o: $(BASE)/utilities/polybench.c
	$(COMP) -c $< -o $@

TARGETS_CLEAN = $(addsuffix _*, $(TARGETS))

clean:
	rm -rf *.o $(TARGETS_CLEAN)

%_base: polybench.o %_base.o
	$(COMP) $^ -o $@

%_time: polybench.o %_time.o
	$(COMP) $^ -o $@

%_ref: polybench.o %_ref.o
	$(COMP) $^ -o $@

%_papi: polybench.o %_papi.o
	$(COMP) $^ -o $@ -lpapi

#
# 2MM
#

B2MM = $(BASE)/linear-algebra/kernels/2mm
F2MM = -D$(SIZE) -I$(BASE)/utilities -I$(B2MM)

2mm: 2mm_base 2mm_time 2mm_ref 2mm_papi

2mm_base.o: $(B2MM)/2mm.c
	$(COMP) $(F2MM) -c $^ -o $@

2mm_time.o: $(B2MM)/2mm.c
	$(COMP) -DPOLYBENCH_TIME $(F2MM) -c $< -o $@

2mm_ref.o: $(B2MM)/2mm.c
	$(COMP) -O0 -DPOLYBENCH_DUMP_ARRAYS $(F2MM) -c $< -o $@

2mm_papi.o: $(B2MM)/2mm.c
	$(COMP) -O3 -DPOLYBENCH_PAPI $(F2MM) -c $< -o $@

#
# 3MM
#

B3MM = $(BASE)/linear-algebra/kernels/3mm
F3MM = -D$(SIZE) -I$(BASE)/utilities -I$(B3MM)

3mm: 3mm_base 3mm_time 3mm_ref 3mm_papi

3mm_base.o: $(B3MM)/3mm.c
	$(COMP) $(F3MM) -c $^ -o $@

3mm_time.o: $(B3MM)/3mm.c
	$(COMP) -DPOLYBENCH_TIME $(F3MM) -c $< -o $@

3mm_ref.o: $(B3MM)/3mm.c
	$(COMP) -O0 -DPOLYBENCH_DUMP_ARRAYS $(F3MM) -c $< -o $@

3mm_papi.o: $(B3MM)/3mm.c
	$(COMP) -O3 -DPOLYBENCH_PAPI $(F3MM) -c $< -o $@ -lpapi

#
# ATAX
#

BATAX = $(BASE)/linear-algebra/kernels/atax
FATAX = -D$(SIZE) -I$(BASE)/utilities -I$(BATAX)

atax: atax_base atax_time atax_ref atax_papi

atax_base.o: $(BATAX)/atax.c
	$(COMP) $(FATAX) -c $< -o $@

atax_time.o: $(BATAX)/atax.c
	$(COMP) -DPOLYBENCH_TIME $(FATAX) -c $< -o $@

atax_ref.o: $(BATAX)/atax.c
	$(COMP) -O0 -DPOLYBENCH_DUMP_ARRAYS $(FATAX) -c $< -o $@

atax_papi.o: $(BATAX)/atax.c
	$(COMP) -O3 -DPOLYBENCH_PAPI $(FATAX) -c $< -o $@ -lpapi

#
# BICG
#

BBICG = $(BASE)/linear-algebra/kernels/bicg
FBICG = -D$(SIZE) -I$(BASE)/utilities -I$(BBICG)

bicg: bicg_base bicg_time bicg_ref bicg_papi

bicg_base.o: $(BBICG)/bicg.c
	$(COMP) $(FBICG) -c $< -o $@

bicg_time.o: $(BBICG)/bicg.c
	$(COMP) -DPOLYBENCH_TIME $(FBICG) -c $< -o $@

bicg_ref.o: $(BBICG)/bicg.c
	$(COMP) -O0 -DPOLYBENCH_DUMP_ARRAYS $(FBICG) -c $< -o $@

bicg_papi.o: $(BBICG)/bicg.c
	$(COMP) -O3 -DPOLYBENCH_PAPI $(FBICG) -c $< -o $@ -lpapi

